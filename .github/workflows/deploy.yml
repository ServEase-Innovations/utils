name: Deploy Utils API

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment"
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # CHECKOUT REPOSITORY
      # ------------------------------
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      # ------------------------------
      # PREPARE CLEAN DEPLOY FOLDER
      # ------------------------------
      - name: Prepare deploy folder
        run: |
          rm -rf deploy
          mkdir deploy

          # Copy ONLY required source files
          cp server.js deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -r controllers deploy/
          cp -r models deploy/
          cp -r routes deploy/
          cp -r services deploy/
          cp -r config deploy/
          cp -r public deploy/
          cp -r views deploy/
          cp -r docs deploy/
          cp global-bundle.pem deploy/ || true
          cp global-bundle.p7b deploy/ || true

          # ------------------------------
          # CREATE ENV FILE BASED ON DROPDOWN
          # ------------------------------
          # GitHub Actions does NOT allow dynamic secrets using upper-case interpolation directly
          # So we use eval on EC2 instead â€” more reliable
          cat <<EOF > deploy/.env
          PROFILE=${{ github.event.inputs.environment }}

          # Razorpay
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
          
          # Mongo (fixed for QA or env based)
          MONGO_URI=${{ secrets.MONGO_URI_QA }}
          
          # PostgreSQL (example QA)
          PG_HOST=${{ secrets.PG_HOST_QA }}
          PG_USER=${{ secrets.PG_USER_QA }}
          PG_PASS=${{ secrets.PG_PASS_QA }}
          EOF

          echo "Deploy folder contents:"
          ls -l deploy

      # ------------------------------
      # UPLOAD USING SCP
      # ------------------------------
      - name: Upload files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy/*"
          target: "/home/ubuntu/utils/"
          overwrite: true
          debug: true

      # ------------------------------
      # SSH & RESTART PM2
      # ------------------------------
      - name: Restart Node App on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "=== Switching to app directory ==="
            cd /home/ubuntu/utils

            echo "=== Installing Dependencies ==="
            npm install --force

            echo "=== Restarting PM2 ==="
            pm2 restart utils || pm2 start server.js --name utils
            pm2 save

            echo "=== PM2 Status ==="
            pm2 status

            echo "=== .env ==="
            cat .env
