name: Deploy Utils API

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment"
        required: true
        type: choice
        options: [dev, qa, uat, prod]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # -------------------------
      # 1. Checkout Repo
      # -------------------------
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      # -------------------------
      # 2. Prepare Deploy Folder
      # -------------------------
      - name: Prepare deploy folder
        run: |
          rm -rf deploy
          mkdir deploy

          # Copy production code files
          cp server.js deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -r controllers deploy/
          cp -r models deploy/
          cp -r routes deploy/
          cp -r services deploy/
          cp -r config deploy/
          cp -r public deploy/
          cp -r views deploy/
          cp -r docs deploy/
          cp global-bundle.pem deploy/ || true
          cp global-bundle.p7b deploy/ || true
          cp ecosystem.config.js deploy/

          # Copy correct environment config file
          if [ "${{ github.event.inputs.environment }}" = "qa" ]; then
              cp .env.qa deploy/.env
          elif [ "${{ github.event.inputs.environment }}" = "dev" ]; then
              cp .env.dev deploy/.env
          elif [ "${{ github.event.inputs.environment }}" = "uat" ]; then
              cp .env.uat deploy/.env
          elif [ "${{ github.event.inputs.environment }}" = "prod" ]; then
              cp .env.prod deploy/.env
          fi

          echo "Deploy environment file:"
          cat deploy/.env

          echo "Prepared deploy folder:"
          ls -l deploy

      # -------------------------
      # 3. Upload Files to EC2
      # -------------------------
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy/*"
          target: "/home/ubuntu/utils/"
          overwrite: true
          debug: true

      # -------------------------
      # 4. Restart Node.js on EC2 using PM2 + ecosystem
      # -------------------------
      - name: Restart Node App
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "=== Installing Dependencies ==="
            cd /home/ubuntu/utils
            npm install --force

            echo "=== Starting/Restarting PM2 App ==="
            pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js --update-env
            pm2 save

            echo "=== PM2 Status ==="
            pm2 status

            echo "=== Printing .env ==="
            cat /home/ubuntu/utils/.env
