name: Deploy Utils API

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment"
        required: true
        type: choice
        options: [dev, qa, uat, prod]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Prepare deploy folder (NO .git, NO junk files)
        run: |
          rm -rf deploy
          mkdir deploy

          # copy source files ONLY
          cp server.js deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -r controllers deploy/
          cp -r models deploy/
          cp -r routes deploy/
          cp -r services deploy/
          cp -r config deploy/
          cp -r public deploy/
          cp -r views deploy/
          cp -r docs deploy/
          cp global-bundle.pem deploy/ || true
          cp global-bundle.p7b deploy/ || true

          # write environment to .env
          echo "PROFILE=${{ github.event.inputs.environment }}" > deploy/.env

          echo "Prepared deploy folder:"
          ls -l deploy

      - name: Upload files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy/*"
          target: "/home/ubuntu/utils/"
          overwrite: true
          debug: true

      - name: Restart Node App on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "=== Installing Dependencies ==="
            cd /home/ubuntu/utils
            npm install --force

            echo "=== Restarting PM2 ==="
            pm2 restart utils || pm2 start server.js --name utils
            pm2 save

            echo "=== PM2 Status ==="
            pm2 status

            echo "=== .env file ==="
            cat /home/ubuntu/utils/.env
