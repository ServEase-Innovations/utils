name: Deploy Utils API

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment"
        required: true
        type: choice
        options: [dev, qa, uat, prod]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Select Profile
        id: select
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "profile=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "qa" ]; then
            echo "profile=qa" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "uat" ]; then
            echo "profile=uat" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "prod" ]; then
            echo "profile=prod" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Prepare deploy folder (NO .git, clean deploy)
        run: |
          rm -rf deploy
          mkdir deploy

          FILES_TO_COPY="server.js package.json package-lock.json global-bundle.pem global-bundle.p7b"
          FOLDERS_TO_COPY="controllers models routes services config public views docs"

          for f in $FILES_TO_COPY; do
            if [ -f "$f" ]; then cp "$f" deploy/; fi
          done

          for d in $FOLDERS_TO_COPY; do
            if [ -d "$d" ]; then cp -r "$d" deploy/; fi
          done

          # Write environment-specific profile
          echo "PROFILE=${{ steps.select.outputs.profile }}" > deploy/.env

          echo "Prepared deploy folder:"
          ls -l deploy

      - name: Upload files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy/*"
          target: "/home/ubuntu/utils/"
          overwrite: true
          debug: true

      - name: Restart Node App on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "=== Installing Dependencies ==="
            cd /home/ubuntu/utils
            npm install --force

            echo "=== Restarting PM2 ==="
            pm2 restart utils || pm2 start server.js --name utils
            pm2 save

            echo "=== PM2 Status ==="
            pm2 status

            echo "=== Current .env File ==="
            cat /home/ubuntu/utils/.env
